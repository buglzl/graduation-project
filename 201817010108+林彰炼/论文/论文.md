# 摘要

&nbsp;&nbsp;&nbsp;&nbsp;随着计算机的运算速度的大幅度提升和计算总体资源的不断增加，卷积神经网络在目标检测上的运用越来越广泛。本文通过阅读大量文献，总结了基于深度学习的二阶段和一阶段神经网络的目标检测算法的基本发展历程，并对其优劣进行了一定的讨论。本文复现了经典的一阶段目标检测网络YOLOv5(YOLO: You Only Look Once)算法。在复现过程中，针对Mosaic数据增强、自适应锚框计算、自适应图片缩放等部分进行了详细介绍。使用VOC2007和VOC2012数据集的训练集和验证集共同作为YOLOv5网络模型进行有监督训练的情况下，在VOC2007测试集上的平均精度可以达到78.2%。高于原文所提到的74.3%，证明了网络复现的有效性。此外，模仿人类视觉感受野，在YOLOv5网络中引入FPN+PAN(FPN: Feature Pyramid Networks；PAN: Pyramid Attention Network)结构后，可以增强卷积神经网络的特征提取能力。实验结果表明，在相同条件下，引入FPN+PAN结构的却可以使YOLOv5网络模型的性能提升。<br>&nbsp;&nbsp;&nbsp;&nbsp; **关键词：** 目标检测；卷积神经网络；YOLOv5；Pytorch

<div STYLE="page-break-after: always;"></div>

# Abstract

&nbsp;&nbsp;&nbsp;&nbsp;With the great increase in computer speed and the continuous increase of computing resources, convolutional neural networks are more and more widely used in object detection. Through the investigation of a large number of literature, this paper summarizes the basic development process of two-stage and first-stage neural networks based on deep learning, and compares their advantages and disadvantages to a certain extent. This article reproduces the classic one-stage object detection network YOLOv5 (YOLO: You Only Look Once) algorithm. In the process of reproduction, detailed designs are made for data storage, data enhancement, main network selection, feature mapping layer selection, default boundary design, and difficult case mining. With supervised training using the training set and validation set of the VOC2007 and VOC2012 datasets together as a YOLOv5 network model, the average accuracy on the VOC2007 test set can reach 78.2%. Higher than the 74.3% mentioned in the original text, it proves the effectiveness of network reproduction and further improvement. In addition, by mimicking human visual perception fields, the feature extraction capabilities of convolutional neural networks can be enhanced by introducing FPN+PAN (FPN: Feature Pyramid Networks; PAN: Pyramid Attention Network) structures in yolOv5 networks. Experimental results show that under the same conditions, the introduction of FPN+PAN structure can improve the accuracy of the YOLOv5 network model by more than 2%.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**Keywords：** Object Detection；Convolutional Neural Networks；YOLOv5；Pytorch

<div STYLE="page-break-after: always;"></div>

# 第一章 绪论

## 1.1 研究背景及意义

&nbsp;&nbsp;&nbsp;&nbsp;随着计算资源的丰富，人们渐渐地不满足于仅仅使用计算机作为普通的运算工具，逐渐将目光投向智能机器，期望其可以像人类一样识别物体，语音，理解文本，甚至能够思考。根据实验心理学家赤瑞特拉（Treicher）做过的心理实验，对于人而言，有83%的信息来自视觉；因此，对于机器智能而言，机器视觉自然也成为了经久不衰的研究方向。目前，机器视觉领域主要研究基本可划分为四类问题：目标分类，解决分析目标 “是什么“ 的问题，给定的图片中一般仅包含一类物体；目标检测，解决物体 “在哪里，是什么” 的问题，图片里可能包含一个或者多个物体，在对物体进行分类的时，同时输出物体在图片里的位置；语义分割，通过查找属于图片的所有像素点，识别图像中存在的内容以及位置；实例分割，在语义分割基础上，进一步将每类的像素点分类到每类的每个实体上，实例分割可以定义为同时解决目标检测问题和语义分割问题的技术。<br>&nbsp;&nbsp;&nbsp;&nbsp;传统机器视觉技术使用图片的数学统计特征来进行分析，由于待测目标成像时存在多样性变化和干扰，手动选择特征没有较好的鲁棒性，这使得传统检测技术的准确性和实时性存在着许多挑战。直到2012年，Hinton等在目标检测数据集 Image Net 大规模视觉识别挑战的分类任务中首次将深层卷积神经网络 Alex Net 应用于大规模图像分类中以获得冠军，再一次为机器视觉领域的研究注入了新活力。目前，已有许多高校、研究院和公司投入大量人力、物力到该领域，期盼能利用机器学习方法在机器视觉领域取得更大突破。如百度、华为等公司已出现自动驾驶相关技术的应用实例。而作为人脸识别、自动驾驶等技术的基础，目标检测领域愈发颇受关注。<br>&nbsp;&nbsp;&nbsp;&nbsp;目标检测领域，提高准确性与实时性一直以来是人们致力于研究的两大方向。然而，在大多数的情况下，准确性与实时性的提升是一对难以调和的矛盾，如何获取它们之间的平衡点是一个十分重要的问题，基于深度学习的目标检测技术的发展也丝毫不例外。<br>&nbsp;&nbsp;&nbsp;&nbsp;多阶段目标检测技术包含区域建议、提取特征、特征分类、边界框回归等多个步骤，技术的发展也主要围绕着对这几个步骤进行改进而发展。例如：区域建议算法从传统的选择搜索算法(SS: selective search)，一直演绎到如今的RPN(RPN: region proposal network)算法；特征提取的主网络也从VGG16，演化到ResNet101等；此外，为了提升目标检测网络的实时性，降低其训练的负载，也演化出许多一阶段目标检测网络，例如YOLO(YOLO: you only look once) ，SSD(SSD：single shot object detector)等，可以同时对图片里所含的物体进行定位和分类。虽然一阶段目标检测网络在实时性上有较大幅度提升，但是其准确率相对于多阶段网络而言，有一定的损失。如何在不损失一阶段目标检测检测速度的前提下，尽可能地提高其准确性，已然成为一个新的研究热点。<br>&nbsp;&nbsp;&nbsp;&nbsp;本文研究基于深度学习的目标检测算法，但鉴于目标检测网络的快速发展，本文将重点研究基于深度学习的一阶段目标检测算法。通过将区域建议、目标分类以及定位合成在一个网络中，大幅度降低了其网络模型的训练时间，同时也加快了其检测速度。针对一阶段目标检测网络，除去了复杂度高的区域建议阶段，在网络的一层或者多层上设计了不同宽高比和不同大小的默认边界，并且针对每一个默认边界进行目标分类和位置回归，最后通过非极大值抑制算法得出目标检测结果。网络模型简洁，训练负载小，检测速度快。<br>&nbsp;&nbsp;&nbsp;&nbsp;本文主要任务是复现目前比较新的YOLO系列算法中的YOLOv5算法。

## 1.2 国内外研究现状分析

&nbsp;&nbsp;&nbsp;&nbsp;基于深度学习的目标检测算法，根据其是否包含单独的区域建议阶段，可以分为多阶段目标检测算法和一阶段目标检测算法。多阶段目标检测算法包含独立的区域建议阶段，其将目标检测分为候选框生成、背景及前景筛选并对前景区域进行分类与位置回归等多个串联步骤。其中的典型代表为R-CNN(R-CNN：Region with CNN features)系列算法。<br>&nbsp;&nbsp;&nbsp;&nbsp;R-CNN算法，首先是通过选择搜索算法对图像的纹理以及颜色等特征进行分析，选出2000个不同大小的候选区域；然后对特征向量进行归一化处理；之后就是通过深度网络对输入的候选区进行前向计算获取特征；再训练支持向量机(support vector machine, SVM)分类器进行分类；最后使用回归器精修每个候选框的位置。在该模型训练时，若存在标记的训练数据稀缺的情况，则先对一个数据丰富的辅助任务进行预训练，然后再对训练目标任务进行网络微调。但R-CNN算法也是有诸多缺点，在候选框提出特征阶段，使用 SS(SS：Selective Search) 算法大约会为每张图片产生出约2000个候选框，那每张图片需要经过2000次CNN前向传播得到特征，并且这2000个候选框有相当多的重叠部分，所以很多计算是重复的；再加上如果数据集有5000张图片，那么总共约有千万个候选框，其所占存储内存极其大；另外其步骤也是十分繁琐的，上面介绍其步骤时可以发现，它的每个阶段分开训练，并不利于取得最优解；在数据集 Pascal VOC2007 中，基于 VGG 卷积神经网络模型的 R-CNN 算法，检测出一张图片的平均时间高达 47 s，平均精度(MAP) 为 66 %，其效果并不理想。<br/>&nbsp;&nbsp;&nbsp;&nbsp;SSP-Net算法在 R-CNN 模型的基础上进行改进，在全连接层前接入的金字塔池化（spatial pyramid pooling, SPP)层来适应各种尺寸的图像输入，解决了 R-CNN 模型由于归一化导致的信息缺失的问题。另外 SPP-Net 模型对 R-CNN 模型的特征提取步骤进行了修改，之前时提取的 2000 个候选区都需要经过 CNN，现在感兴趣区域（region of interest, ROI）特征可以直接从特征图里获取，使得运行速度得到极大提高。但缺点也相当明显，运行时仍需占用巨大空间。 <br>&nbsp;&nbsp;&nbsp;&nbsp;Fast R-CNN算法在之前基础上，解决了训练分布过多和训练时间和内存消耗较大的问题。Fast R-CNN 结合了 SPP-Net 的优点，再将 R-CNN 网络进行改进：将整张图片进行卷积操作，减少了重复计算；整张图片进行归一化处理后再送入深度网络，通过最后少数几层处理每一个候选框，提升了其运行速度；引入了多任务损失（multi-task loss）函数，用深度网络实现类别判断和位置调整，较少了内存的占用。在以 VGG16 为特征提取的主体网络时，在 VOC2007 数据集上，一张图片的测试时间为 0.32，MAP 达到了 66.9%。虽然其训练和检测速度有所提升，在不考虑区域建议步骤所耗时间的基础上，勉强达到了实时检测的要求，但其使用的传统区域建议算法 SS，耗时几乎和主网络一致，也就成为了该算法在速度提升上的瓶颈。<br/> &nbsp;&nbsp;&nbsp;&nbsp;为了进一步提升算法速度，Faster R-CNN算法将目标检测的 4 个基本步骤全部整合在一个深度网络中，提高了算法的综合性能，尤其是在检测速度方面。该算法首先是将图像输入卷积网络中，生成特征映射；其次使用区域投标网络（region proposal network, RPN），在生成候选区域时产生锚点（anchors）通过函数判别并使用边框回归调整 Archors 以获得确切的候选区域；之后通过 ROI 池化层，解决了最后输入全连接层的特征图尺寸大小不同的问题；最后通过完全连接层判断目标类别和精准位置。简言之，相比于 Fast R-CNN 算法，Faster R-CNN 算法主要改进点就是整合与引入了 RPN 结构。&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在多阶段目标检测算法不断进步的同时，部分研究者另辟蹊径，进一步提出了一阶段目标检测算法，包括YOLO，SSD等。<br>&nbsp;&nbsp;&nbsp;&nbsp;YOLO算法，直接舍弃了候选框提取，直接采用回归的方法对物体分类和候选框进行预测。这种改进方法简化了网络结构，其检测速度提升至 Faster R-CNN 算法的 10 倍左右。从此，基于深度学习的目标检测算法有了能够满足实时性的条件。目前 YOLO 系列算法已经到了 v5 版本，即 YOLOv5。从其提出至今，一直在不断改进提升，但仍然存在着物体定位准确度低，召回率差等问题需要解决。之后将在 2.2.3 详细介绍 YOLO 系列算法步骤。<br>&nbsp;&nbsp;&nbsp;&nbsp;SSD 算法，解决了同时期 YOLO 算法中存在的定位精度低以及难以检测小目标等问题。其改进方案有：首先在用 CNN 来直接进行检测，避免了 YOLO 方法在全连接之后再进行检测的操作；然后通过快速检测不同尺度特征图的准确度，明确区分预测；最后结合 Faster R-CNN 算法中的 Anchor 机制，通过大小不同的先验框在特征图中获取候选区域，提高了召回率。之后随着该算法的发展，又提出了 DSSD 和 FSSD 算法。总的来看， SSD 系列算法在对小目标检测算法中有着更好的精度与性能，算法发展方向也基本往此处走。<br>&nbsp;&nbsp;&nbsp;&nbsp;综上所述，一阶段目标检测算法 YOLO 具有实现实时检测的潜能，因此重现 YOLO 算法，详述其理论并对其成功运行，具有较大的深度学习理论性指导意义。

## 1.3 本文的主要工作及篇章结构

&nbsp;&nbsp;&nbsp;&nbsp;本文的主要工作是基于 Python 语言的 Pytorch 架构，对于经典的基于卷积神经网络的目标检测算法 YOLOv5s 进行复现。首先，叙述了常见的基于深度学习的几种目标检测算法及其发展关系；其次，总结了部分传统目标检测算法可以迁移运用的几种思想。随后再概述卷积神经网络的基本架构以及常用数据集与评测指标。最后对目标检测算法 YOLOv5s 的设计方案进行详细分析与现。<br>&nbsp;&nbsp;&nbsp;&nbsp;第一章从本文的研究背景与实际意义出发，概述了基于神经网络的二阶段和一阶段目标检测算法，并分析了算法性能与其相互之间的发展关系以及优劣比较。<br>&nbsp;&nbsp;&nbsp;&nbsp;第二章概述了常见的目标检测算法，包括传统目标检测算法，如基于Haar纹理特征、用于人脸识别的 V-J 算法、基于方向梯度直方图特征的算法等；此外，还有基于深度学习的目标检测算法的主要架构，训练方法，常用数据集及主要衡量指标。<br>&nbsp;&nbsp;&nbsp;&nbsp;第三章详细介绍了基于卷积神经网络的目标检测算法 YOLOv5s 的复现过程。<br>&nbsp;&nbsp;&nbsp;&nbsp;第四章主要展示了模型的训练结果与实现测试效果。<br>&nbsp;&nbsp;&nbsp;&nbsp;第五章对本文的研究成果进行总结，指出了本文在网络复现过程中的难点，并提出了未来可能的几个研究方向。 

# 第二章 目标检测算法概述

## 2.1 传统目标检测算法

&nbsp;&nbsp;&nbsp;&nbsp;在卷积神经网络被广泛应用于目标检测之前，由于缺乏足够的手段来提取特征，早期的目标检测算法多是基于各种统计特征所构建的，如Haar特征，HOG特征等。同时，由于计算资源的匮乏，人们不得不同时寻找更加精巧的计算方法来加速目标检测模型。图2.1展示了传统的目标检测算法流程。<br>

![](2.1.png)

<center>图2.1 传统目标检测算法流程</center>

&nbsp;&nbsp;&nbsp;&nbsp;虚线框所包含部分为传统目标检测算法与基于深度学习的多阶段目标检测算法在流程上相似，但处理方法有异的地方。传统目标检测算法多采用保守的候选框提出方法，如滑动窗口结合图片特征金字塔的方法；此外，其提取的特征主要包括图片的统计特征，底层特征和中层次特征，如颜色，纹理等；多采用支持向量机算法，Adaboost算法等将所提取的图片特征分至若干物体类。使用选择性搜索算法，或是神经网络提出候选框，是基于深度学习的多阶段目标检测算法中更为常用的区域建议方案；而一阶段目标检测算法直接设计一系列默认边界，同时完成物体识别和位置回归两个任务，无需使用单独步骤提取候选框；其次，其主要使用卷积神经网络和全连接层进行特征提取及分类和定位。<br>&nbsp;&nbsp;&nbsp;&nbsp;2001年提出的V-J目标检测算法，第一次基本实现了人脸的实时检测。其采用最基础的滑动窗口方式提出候选框，即在图像的每一个像素点对每一种可能的尺度进行遍历，逐一判断其是否为人脸目标。其提取多尺度Haar特征，即白色像素点与黑色像素点的差分，来表现图片的各种纹理特征。设计了过完备的随机Haar特征，并使用Adaboost算法从该过完备集中选取那些对人脸检测最为有用的几种特征，由此减小不必要的计算开销。其流程如表2.1所示：

<center>表2.1  V-J算法主要流程</center>

| 表2.1  V-J算法主要流程 |
|:--|
|1.	初始化样本权重w，使权重之和为1；|
|2.	训练弱分类器Adaboost。其每一步迭代仅使用了18万特征中的一个，因此称之为弱分类器；|
|3.	更新样本权重；|
|4.	重复步骤2，直到达到最大步骤数；|
|5.	结合多个弱分类器的结果进行投票。|

&nbsp;&nbsp;&nbsp;&nbsp;传统目标检测算法中常用的另一种统计特征是方向梯度直方图特征(HOG：Histogram of Oriented Gradient)。其使用图片中若干个连通区域的像素点梯度直方图作为特征描述符。提取HOG特征的目标检测算法，多采用窗口大小固定的检测器，使图像依次缩放后构建多尺度图像金字塔的方法来提出候选框。为了兼顾检测速度和识别精度，HOG检测通常采用线性分类器或级联决策分类器。但HOG特征很难处理遮挡问题，图片中所包含的人体姿势动作幅度过大或物体方向改变也不易被检测。<br>&nbsp;&nbsp;&nbsp;&nbsp;可变部件模型算法(DPM：Deformable Part based Model)算法是一种基于物体部件的目标检测算法，对物体可能发生的姿势改变、角度改变等可能发生的形变具有很强的鲁棒性。其提取改进后的HOG特征，即将当前细胞单元与其相邻四个单元统一进行归一化以提取特征。在模型结构上，其由一系列滤波器构成，以分解一个物体不同的部件。如：针对行人，可以分解为头部，躯干，四肢等部分；针对汽车，可分解为车身、轮胎等部分。在模型训练时，使用弱监督学习策略，不需要图片标注一个物体的全部结构，仅有部分结构进行标注也可以进行学习。<br>&nbsp;&nbsp;&nbsp;&nbsp;2012年以来，神经网络技术为目标检测领域注入了新的活力。尽管基于神经网络技术的相关算法在很多机器视觉任务上的表现优于传统算法，如图片分类，目标检测等。但是以目标检测算法为例，我们可以发现运用在传统目标检测算法中的很多思想对当今的目标检测算法仍有着不可忽视的影响。例如，基于深度学习的二阶段目标检测算法在算法流程上基本继承了传统目标检测算法的思路。DPM等算法中使用的难样本挖掘技术，针对默认边界进行位置回归，上下文信息的利用等，即使在一阶段目标检测算法的网络设计中也体现了相关思想，如SSD算法严格控制正负样本比例约为1:3以进行难例挖掘；引入扩张卷积层以更好的利用图片的上下文信息。<br>

## 2.2 基于深度学习的目标检测算法



